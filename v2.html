<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Finanzas Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Un gris claro para el fondo */
            color: #333;
        }

        /* Estilos personalizados para el acordeón */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
            opacity: 0;
        }
        .accordion-content.active {
            max-height: 1000px; /* Suficiente para el contenido de las secciones */
            opacity: 1;
        }
        .accordion-toggle.active svg {
            transform: rotate(180deg);
        }

        /* Estilos para la tabla de deudas y gastos */
        .debt-table th, .debt-table td,
        .expense-table th, .expense-table td,
        .transaction-table th, .transaction-table td,
        .monthly-plan-table th, .monthly-plan-table td,
        .amortization-table th, .amortization-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* border-gray-200 */
        }
        .debt-table th, .expense-table th, .transaction-table th, .monthly-plan-table th, .amortization-table th {
            background-color: #edf2f7; /* bg-gray-100 */
            font-weight: 600; /* font-semibold */
            color: #4a5568; /* text-gray-700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
        }
        .debt-table tbody tr:last-child td,
        .expense-table tbody tr:last-child td,
        .transaction-table tbody tr:last-child td,
        .monthly-plan-table tbody tr:last-child td,
        .amortization-table tbody tr:last-child td {
            border-bottom: none;
        }
        /* Efectos Hover Mejorados para tablas */
        .debt-table tbody tr:hover,
        .expense-table tbody tr:hover,
        .transaction-table tbody tr:hover,
        .monthly-plan-table tbody tr:hover,
        .amortization-table tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05); /* blue-500 con 5% de opacidad */
            transition: all 0.2s ease;
        }

        /* Estilos para el estilo Mac OS Sequoia */
        /* Efecto Vidrio (Glassmorphism) */
        .container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
        }

        /* Tema oscuro automático */
        @media (prefers-color-scheme: dark) {
            .container {
                background: rgba(30, 30, 32, 0.8);
                border: 1px solid rgba(60, 60, 65, 0.5);
            }
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }
            .accordion-item, .bg-gray-50 {
                background-color: rgba(40, 40, 42, 0.8);
                border-color: rgba(60, 60, 65, 0.5);
            }
            .accordion-toggle {
                background: linear-gradient(180deg, #2a2a2c, #3a3a3e);
                border-bottom-color: rgba(60, 60, 65, 0.5);
                color: #e0e0e0;
            }
            .accordion-toggle:hover {
                background: linear-gradient(180deg, #3a3a3e, #4a4a4e);
            }
            .debt-table th, .expense-table th, .transaction-table th, .monthly-plan-table th, .amortization-table th {
                background-color: rgba(50, 50, 52, 0.8);
                color: #c0c0c0;
            }
            .debt-table td, .expense-table td, .transaction-table td, .monthly-plan-table td, .amortization-table td {
                border-bottom-color: rgba(60, 60, 65, 0.5);
            }
            .debt-table tbody tr:hover, .expense-table tbody tr:hover, .transaction-table tbody tr:hover, .monthly-plan-table tbody tr:hover, .amortization-table tbody tr:hover {
                background-color: rgba(59, 130, 246, 0.1);
            }
            input, select {
                background: rgba(50, 50, 52, 0.7);
                border-color: rgba(80, 80, 85, 0.5);
                color: #e0e0e0;
            }
            input::placeholder {
                color: #a0a0a0;
            }
            .error-message {
                color: #f87171; /* red-400 for dark mode */
            }
        }

        .accordion-item {
            border-radius: 1.25rem; /* Bordes más redondeados */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Sombra sutil */
        }
        .accordion-toggle {
            border-radius: 1.25rem 1.25rem 0 0; /* Bordes superiores redondeados */
            background: linear-gradient(180deg, #f9fafb, #f3f4f6); /* Degradado suave */
            border-bottom: 1px solid #e5e7eb;
        }
        .accordion-toggle:hover {
            background: linear-gradient(180deg, #f3f4f6, #e5e7eb);
        }
        button:not(.accordion-toggle) {
            border-radius: 0.75rem; /* Botones más redondeados */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        /* Efectos Hover Mejorados para botones */
        button:not(.accordion-toggle):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        /* Animación para el click del botón */
        button:not(.accordion-toggle):active {
            transform: scale(0.98);
        }

        input[type="text"], input[type="number"], input[type="date"], select {
            border-radius: 0.75rem; /* Campos de entrada redondeados */
            border: 1px solid #d1d5db;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Mejoras en los formularios */
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.7);
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            border-color: #3b82f6; /* Borde azul al enfocar */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Anillo de enfoque azul translúcido */
        }
        .modal-content {
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        /* Estilos para Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInOut 3.5s forwards; /* Duración total de la animación */
            z-index: 1000;
        }
        .toast.success { background-color: #28a745; } /* Tailwind green-600 */
        .toast.error { background-color: #dc3545; } /* Tailwind red-600 */
        .toast.warning { background-color: #ffc107; color: #333; } /* Tailwind yellow-500 */
        .toast.info { background-color: #007bff; } /* Tailwind blue-500 */

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        /* Animación para elementos de tabla al ser añadidos */
        /* Animaciones al Añadir Elementos */
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .new-item {
            animation: fadeInScale 0.3s ease-out forwards;
        }

        /* Estilo para mensajes de error de validación */
        .input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
            /* Animación de shake para errores */
            animation: shake 0.5s;
        }
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-3px); }
            40%, 80% { transform: translateX(3px); }
        }

        /* Scrollbars Estilizadas (como macOS) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Estilo para el menú contextual */
        .context-menu {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            padding: 0.5rem;
            z-index: 1000;
        }
        .context-menu-item {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            text-align: left;
            font-size: 0.9rem;
            color: #333;
            border-radius: 0.5rem;
            transition: background-color 0.15s ease;
            cursor: pointer; /* Añadido para indicar que es clickeable */
        }
        .context-menu-item:hover {
            background-color: rgba(59, 130, 246, 0.1); /* blue-500 con 10% de opacidad */
        }
        .context-menu-item.text-red-500:hover {
            background-color: rgba(239, 68, 68, 0.1); /* red-500 con 10% de opacidad */
        }
        @media (prefers-color-scheme: dark) {
            .context-menu {
                background: rgba(50, 50, 52, 0.9);
                border: 1px solid rgba(80, 80, 85, 0.5);
            }
            .context-menu-item {
                color: #e0e0e0;
            }
            .context-menu-item:hover {
                background-color: rgba(59, 130, 246, 0.2);
            }
            .context-menu-item.text-red-500:hover {
                background-color: rgba(239, 68, 68, 0.2);
            }
        }

        /* Estilo Adicional para Inputs Monetarios */
        input[inputmode="numeric"] {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }

        /* Indicador de moneda */
        .currency-input-wrapper {
            position: relative;
        }

        .currency-input-wrapper::before {
            content: attr(data-currency-symbol); /* Usar atributo data */
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
            z-index: 10; /* Asegura que el símbolo esté sobre el input */
        }

        .currency-input-wrapper input {
            padding-left: 30px !important; /* Ajusta el padding para el símbolo */
        }
        
        /* Estilos para sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
        }
        input[type="range"]::-moz-range-track {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -6px; /* Half of the thumb height */
            background-color: #3b82f6; /* blue-500 */
            border: 2px solid #fff;
            border-radius: 50%;
            height: 20px;
            width: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, transform 0.2s;
        }
        input[type="range"]::-moz-range-thumb {
            background-color: #3b82f6; /* blue-500 */
            border: 2px solid #fff;
            border-radius: 50%;
            height: 20px;
            width: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, transform 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background-color: #2563eb; /* blue-600 */
            transform: scale(1.1);
        }
        input[type="range"]::-moz-range-thumb:hover {
            background-color: #2563eb; /* blue-600 */
            transform: scale(1.1);
        }
        @media (prefers-color-scheme: dark) {
            input[type="range"]::-webkit-slider-runnable-track {
                background: rgba(80, 80, 85, 0.5);
            }
            input[type="range"]::-moz-range-track {
                background: rgba(80, 80, 85, 0.5);
            }
            input[type="range"]::-webkit-slider-thumb,
            input[type="range"]::-moz-slider-thumb {
                background-color: #6366f1; /* indigo-500 */
                border-color: #1a1a1a;
            }
            input[type="range"]::-webkit-slider-thumb:hover,
            input[type="range"]::-moz-slider-thumb:hover {
                background-color: #4f46e5; /* indigo-600 */
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            .modal-content {
                background-color: #2a2a2e;
                color: #e0e0e0;
            }
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close-button:hover {
            color: #333;
        }
        @media (prefers-color-scheme: dark) {
            .modal-close-button {
                color: #a0a0a0;
            }
            .modal-close-button:hover {
                color: #e0e0e0;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos para la nueva sección de Respaldo y Carga */
        .panel-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        @media (prefers-color-scheme: dark) {
            .panel-section {
                background: rgba(30, 30, 32, 0.8);
                border: 1px solid rgba(60, 60, 65, 0.5);
            }
        }
        .panel-section-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #333; /* text-gray-800 */
            margin-bottom: 1rem;
            text-align: center;
        }
        @media (prefers-color-scheme: dark) {
            .panel-section-title {
                color: #e0e0e0;
            }
        }
        .panel-section-content {
            padding: 1rem;
            background: rgba(245, 247, 250, 0.7);
            border-radius: 1rem;
            border: 1px solid rgba(230, 235, 245, 0.6);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
        }
        @media (prefers-color-scheme: dark) {
            .panel-section-content {
                background: rgba(40, 42, 48, 0.7);
                border: 1px solid rgba(60, 65, 75, 0.6);
            }
        }
        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .primary-button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .primary-button:hover {
            background-color: #2563eb; /* blue-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .secondary-button {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .secondary-button:hover {
            background-color: #d1d5db; /* gray-300 */
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        .text-caption {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
            text-align: center;
        }
        @media (prefers-color-scheme: dark) {
            .primary-button {
                background-color: #6366f1; /* indigo-500 */
            }
            .primary-button:hover {
                background-color: #4f46e5; /* indigo-600 */
            }
            .secondary-button {
                background-color: #4b5563; /* gray-700 */
                color: #e0e0e0;
                border-color: #6b7280; /* gray-500 */
            }
            .secondary-button:hover {
                background-color: #6b7280; /* gray-500 */
            }
            .text-caption {
                color: #9ca3af; /* gray-400 */
            }
        }
    </style>
</head>
<body class="p-4 relative">
    <div class="absolute top-4 right-4 bg-white/80 backdrop-blur-sm rounded-xl p-4 shadow-lg border border-gray-200/50 z-10 flex items-center space-x-3">
        <div>
            <h3 class="font-semibold text-gray-700 mb-2">Resumen Rápido</h3>
            <div class="space-y-1">
                <div class="flex justify-between">
                    <span class="text-sm">Disponible:</span>
                    <span id="quickAvailable" class="font-medium text-green-600">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm">Deudas:</span>
                    <span id="quickDebts" class="font-medium text-red-600">$0</span>
                </div>
            </div>
        </div>
        <div>
            <label for="currencySelect" class="block text-xs font-medium text-gray-700 mb-1">Moneda</label>
            <select id="currencySelect" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                <option value="USD">USD ($)</option>
                <option value="ARS">ARS ($)</option>
                <option value="MXN">MXN ($)</option>
                <option value="EUR">EUR (€)</option>
                <option value="COP">COP ($)</option>
            </select>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-4xl bg-white rounded-xl shadow-lg">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Gestor de Finanzas Personales</h1>

        <div class="relative mb-8 max-w-md mx-auto">
            <input type="text" id="spotlightSearch" placeholder="⌘K para buscar..." 
                    class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#incomePanel">
                <span>💰 Mis Ingresos</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="incomePanel" class="accordion-content p-4 border-t border-gray-200">
                <p class="text-gray-600 mb-4">Define tus ingresos para un cálculo preciso de tu dinero disponible después de gastos fijos y deudas.</p>
                <div class="space-y-4 mb-6 p-4 bg-white rounded-lg shadow-inner border border-gray-200">
                    <div>
                        <label for="monthlyIncomeAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto de Ingreso:</label>
                        <div class="currency-input-wrapper" data-currency-symbol="$">
                            <input type="text" id="monthlyIncomeAmount" inputmode="numeric" pattern="[0-9,.]*" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <p id="incomeAmountError" class="error-message hidden">El monto debe ser un número positivo y no exceder los 12 dígitos.</p>
                    </div>
                    <div>
                        <label for="incomeFrequency" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia del Ingreso:</label>
                        <select id="incomeFrequency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Mensual">Mensual</option>
                            <option value="Quincenal">Quincenal</option>
                        </select>
                    </div>
                    <button id="saveIncomeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                        Guardar Ingreso
                    </button>
                </div>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#fixedExpensesPanel">
                <span>💸 Gastos Fijos</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="fixedExpensesPanel" class="accordion-content p-4 border-t border-gray-200">
                <form id="fixedExpenseForm" class="space-y-4 mb-6">
                    <div>
                        <label for="expenseName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Gasto:</label>
                        <input type="text" id="expenseName" placeholder="Ej: Alquiler" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto:</label>
                        <div class="currency-input-wrapper" data-currency-symbol="$">
                            <input type="text" id="expenseAmount" inputmode="numeric" pattern="[0-9,.]*" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <p id="expenseAmountError" class="error-message hidden">El monto debe ser un número positivo y no exceder los 12 dígitos.</p>
                    </div>
                    <div>
                        <label for="expenseFrequency" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia:</label>
                        <select id="expenseFrequency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                            <option value="Mensual">Mensual</option>
                            <option value="Quincenal">Quincenal</option>
                            <option value="Semanal">Semanal</option>
                            <option value="Anual">Anual</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                        Guardar Gasto Fijo
                    </button>
                </form>

                <h4 class="text-lg font-semibold text-gray-700 mb-3">Mis Gastos Fijos:</h4>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full bg-white expense-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Monto</th>
                                <th>Frecuencia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="fixedExpenseList">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">No hay gastos fijos registrados.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#addDebtPanel">
                <span>➕ Agregar Nueva Deuda</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="addDebtPanel" class="accordion-content p-4 border-t border-gray-200">
                <form id="debtForm" class="space-y-4">
                    <div>
                        <label for="debtName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la deuda:</label>
                        <input type="text" id="debtName" placeholder="Ej: Préstamo bancario" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="debtAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto Principal:</label>
                        <div class="currency-input-wrapper" data-currency-symbol="$">
                            <input type="text" id="debtAmount" inputmode="numeric" pattern="[0-9,.]*" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <p id="debtAmountError" class="error-message hidden">El monto debe ser un número positivo y no exceder los 12 dígitos.</p>
                    </div>
                    <div>
                        <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de vencimiento:</label>
                        <input type="date" id="dueDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="debtCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría:</label>
                        <select id="debtCategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                            <option value="">Seleccione una categoría</option>
                            <option value="Préstamo Bancario">Préstamo Bancario</option>
                            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                            <option value="Hipoteca">Hipoteca</option>
                            <option value="Automóvil">Automóvil</option>
                            <option value="Estudios">Estudios</option>
                            <option value="Personal">Personal</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label for="termInMonths" class="block text-sm font-medium text-gray-700 mb-1">Plazo (meses) para esta deuda:</label>
                        <input type="text" id="termInMonths" inputmode="numeric" pattern="[0-9]*" placeholder="Ej: 12" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p id="termInMonthsError" class="error-message hidden">El plazo debe ser un número entero positivo y no exceder los 12 dígitos.</p>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                        Guardar Deuda
                    </button>
                </form>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#myDebtsPanel">
                <span>📝 Mis Deudas</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="myDebtsPanel" class="accordion-content p-4 border-t border-gray-200">
                <div class="flex flex-wrap gap-4 mb-4">
                    <select id="filterCategory" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="all">Todas las categorías</option>
                        <option value="Préstamo Bancario">Préstamo Bancario</option>
                        <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                        <option value="Hipoteca">Hipoteca</option>
                        <option value="Automóvil">Automóvil</option>
                        <option value="Estudios">Estudios</option>
                        <option value="Personal">Personal</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <select id="filterStatus" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="all">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagada">Pagada</option>
                    </select>
                    <button id="clearFiltersBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-sm transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
                        Limpiar Filtros
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full bg-white debt-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Monto</th>
                                <th>Cuota Mensual Est.</th>
                                <th>Vencimiento</th>
                                <th>Categoría</th>
                                <th>Plazo (meses)</th>
                                <th>Ahorro Diario Rec.</th>
                                <th>Ahorro Quincenal Rec.</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="debtList">
                            <tr>
                                <td colspan="10" class="text-center py-4 text-gray-500">No hay deudas registradas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <button id="clearAllDebtsBtn" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                    🗑️ Limpiar Todas las Deudas
                </button>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#debtStrategyPanel">
                <span>🏆 Estrategias de Pago de Deudas</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="debtStrategyPanel" class="accordion-content p-4 border-t border-gray-200">
                <p class="text-gray-600 mb-4">Define tu capacidad de ahorro mensual adicional para ver la estrategia óptima de liquidación de deudas.</p>
                <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <label for="monthlySavingsSlider" class="block font-medium text-blue-800 mb-2">Ahorro Mensual Adicional para Deudas:</label>
                    <input type="range" id="monthlySavingsSlider" min="0" max="5000000" step="10000" value="100000" 
                           class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-blue-600 mt-1">
                        <span>$0</span>
                        <span id="savingsValue" class="font-bold text-blue-800">$100,000</span>
                        <span>$5M</span>
                    </div>
                </div>

                <div id="strategyComparison" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Plan Mensual Detallado de Pagos:</h4>
                    <div class="flex gap-2 mb-3">
                        <button id="showSnowballPlan" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-lg font-medium hover:bg-blue-200 transition duration-200">Ver Plan Bola de Nieve</button>
                        <button id="showAvalanchePlan" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-lg font-medium hover:bg-purple-200 transition duration-200">Ver Plan Avalancha</button>
                    </div>
                    <div id="monthlyPlanResults" class="mt-4">
                        <p class="text-gray-600">Selecciona una estrategia para ver el plan detallado.</p>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        Estrategia Personalizada con IA ✨
                    </h3>
                    <p class="text-gray-600 mb-4">Obtén una recomendación de estrategia de pago de deudas adaptada a tu situación actual, generada por inteligencia artificial.</p>
                    <button id="getGeminiStrategyBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 flex items-center justify-center">
                        <span id="geminiButtonText">Obtener Estrategia Personalizada ✨</span>
                        <div id="geminiLoadingSpinner" class="spinner ml-2 hidden"></div>
                    </button>
                    <div id="geminiStrategyOutput" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                        </div>
                </div>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#aiAdvisorPanel">
                <span>💬 Consejero Financiero Rápido con IA ✨</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="aiAdvisorPanel" class="accordion-content p-4 border-t border-gray-200">
                <p class="text-gray-600 mb-4">Haz una pregunta general sobre finanzas personales y obtén un consejo rápido de nuestra IA.</p>
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="financialQuestion" class="block text-sm font-medium text-gray-700 mb-1">Tu pregunta financiera:</label>
                        <textarea id="financialQuestion" rows="4" placeholder="Ej: ¿Es mejor pagar deudas o invertir primero?" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                    </div>
                    <button id="getAiAdviceBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 flex items-center justify-center">
                        <span id="aiAdviceButtonText">Obtener Consejo Financiero ✨</span>
                        <div id="aiAdviceLoadingSpinner" class="spinner ml-2 hidden"></div>
                    </button>
                    <div id="aiAdviceOutput" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                        </div>
                </div>
            </div>
        </div>


        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#scenarioSimulatorPanel">
                <span>🔮 Simulador de Escenarios Futuros</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="scenarioSimulatorPanel" class="accordion-content p-4 border-t border-gray-200">
                <p class="text-gray-600 mb-4">Ajusta estos valores para simular cómo cambiaría tu situación financiera:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <label for="incomeChange" class="block font-medium text-blue-800 mb-1">Cambio en ingresos (%):</label>
                        <input type="range" id="incomeChange" min="-50" max="50" step="5" value="0" 
                               class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-blue-600 mt-1">
                            <span>-50%</span>
                            <span id="incomeChangeValue">0%</span>
                            <span>+50%</span>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <label for="expenseChange" class="block font-medium text-purple-800 mb-1">Cambio en gastos fijos (%):</label>
                        <input type="range" id="expenseChange" min="-30" max="30" step="5" value="0" 
                               class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-purple-600 mt-1">
                            <span>-30%</span>
                            <span id="expenseChangeValue">0%</span>
                            <span>+30%</span>
                        </div>
                    </div>
                </div>
                <button id="runSimulation" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300">
                    Simular Escenario
                </button>
                <div id="simulationResults" class="mt-6 hidden">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-lg mb-3">Resultados del Escenario Simulado:</h4>
                        <div id="scenarioComparison" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#summaryPanel">
                <span>📊 Resumen Financiero y Plan de Ahorro Global</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="summaryPanel" class="accordion-content p-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-blue-800">Total de deudas pendientes:</p>
                        <p id="totalDebts" class="text-2xl font-bold text-blue-900">$ 0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-purple-800">Dinero disponible:</p>
                        <p id="availableMoney" class="text-2xl font-bold text-purple-900">$ 0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-red-800">Porcentaje de deuda:</p>
                        <p id="debtPercentage" class="text-2xl font-bold text-red-900">0 %</p>
                    </div>
                </div>

                <div class="mt-4 mb-6">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Progreso de deudas</span>
                        <span id="debtProgressText" class="text-sm text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="debtProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Plan de Ahorro Global para Saldo Total de Deudas</h3>
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="targetTermMonths" class="block text-sm font-medium text-gray-700 mb-1">Plazo deseado para saldar todas las deudas (meses):</label>
                        <input type="text" id="targetTermMonths" inputmode="numeric" pattern="[0-9]*" min="1" value="12" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <p id="targetTermMonthsError" class="error-message hidden">El plazo debe ser un número entero positivo y no exceder los 12 dígitos.</p>
                    </div>
                    <button id="calculateSavingsBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        Calcular Ahorro Necesario
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                    <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-green-800">Ahorro Diario Necesario:</p>
                        <p id="dailySavings" class="text-2xl font-bold text-green-900">$ 0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm font-medium text-yellow-800">Ahorro Quincenal Necesario:</p>
                        <p id="biWeeklySavings" class="text-2xl font-bold text-yellow-900">$ 0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item bg-gray-50 rounded-lg shadow-sm mb-4 border border-gray-200">
            <button class="accordion-toggle w-full text-left p-4 font-semibold text-xl flex justify-between items-center text-gray-700 hover:bg-gray-100 transition duration-200 ease-in-out rounded-t-lg" data-target="#backupRestorePanel">
                <span>💾 Respaldo y Carga de Datos</span>
                <svg class="w-6 h-6 transform transition-transform duration-300 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="backupRestorePanel" class="accordion-content p-4 border-t border-gray-200">
                <p class="text-gray-600 mb-4">Gestiona tus datos financieros con las opciones de respaldo y carga.</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 flex items-center justify-center" onclick="exportData()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Exportar Datos (.json)
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData()">
                    <button class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 flex items-center justify-center" onclick="document.getElementById('importFile').click()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Importar Datos (.json)
                    </button>
                </div>
                <p class="text-sm text-gray-500 text-center mt-4">Al importar datos, los datos actuales serán sobrescritos. Asegúrate de haber exportado antes si deseas conservarlos.</p>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-4 mt-8">
            <button id="categoryAnalysisBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                📈 Análisis por Categoría
            </button>
            <button id="statisticsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                📊 Estadísticas
            </button>
            <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                📊 Exportar a Excel
            </button>
            <button id="resetAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                🗑️ Restablecer Todo
            </button>
        </div>
    </div>

    <div id="contextMenu" class="context-menu absolute hidden bg-white rounded-lg shadow-lg py-1">
        <button class="context-menu-item" data-action="markAsPaid">Marcar como pagada</button>
        <button class="context-menu-item" data-action="editDebt">Editar deuda</button>
        <button class="context-menu-item" data-action="viewIndividualPlan">Ver Plan de Pago</button>
        <button class="context-menu-item text-red-500" data-action="deleteDebt">Eliminar deuda</button>
    </div>

    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeConfirmationModal">&times;</button>
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="modalCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Cancelar</button>
                <button id="modalConfirmBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="individualPlanModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="closeIndividualPlanModal">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Plan de Pago Individual: <span id="modalDebtName"></span></h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-gray-700">
                <div><span class="font-semibold">Monto Principal:</span> <span id="modalDebtAmount"></span></div>
                <div><span class="font-semibold">Plazo Original:</span> <span id="modalTermInMonths"></span></div>
                <div><span class="font-semibold">Cuota Mensual Original:</span> <span id="modalMonthlyPayment"></span></div>
            </div>

            <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Simular Pago Adicional</h3>
                <div>
                    <label for="extraPaymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto de Pago Adicional Mensual:</label>
                    <div class="currency-input-wrapper" data-currency-symbol="$">
                        <input type="text" id="extraPaymentAmount" inputmode="numeric" pattern="[0-9,.]*" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <p id="extraPaymentError" class="error-message hidden">El monto debe ser un número positivo.</p>
                </div>
                <button id="recalculatePlanBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    Recalcular Plan
                </button>
            </div>

            <div id="amortizationSummary" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <p class="font-semibold text-blue-800">Resumen del Plan:</p>
                <p>Tiempo estimado de pago: <span id="summaryMonths"></span> meses</p>
                <p>Interés total pagado: <span id="summaryTotalInterest"></span></p>
            </div>

            <h3 class="text-lg font-semibold text-gray-700 mb-3">Tabla de Amortización:</h3>
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full bg-white amortization-table">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Saldo Inicial</th>
                            <th>Principal Pagado</th>
                            <th>Pago Total</th>
                            <th>Saldo Final</th>
                        </tr>
                    </thead>
                    <tbody id="amortizationTableBody">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Calcula un plan de pago.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        // Envuelve todo el código JavaScript en una IIFE para evitar conflictos de variables globales
        (function() {
            // --- Variables Globales y Estado ---
            let debts = loadData('debts', []);
            let fixedExpenses = loadData('fixedExpenses', []);
            let monthlyIncome = loadData('monthlyIncome', 0);
            let incomeFrequency = loadData('incomeFrequency', 'Mensual');

            let editingDebtId = null; // Para la edición de deudas
            let editingFixedExpenseId = null; // Para la edición de gastos fijos

            // --- Referencias DOM ---
            const debtForm = document.getElementById('debtForm');
            const debtNameInput = document.getElementById('debtName');
            const debtAmountInput = document.getElementById('debtAmount');
            const dueDateInput = document.getElementById('dueDate');
            const debtCategorySelect = document.getElementById('debtCategory');
            const termInMonthsInput = document.getElementById('termInMonths');
            const debtList = document.getElementById('debtList');
            const addDebtBtn = debtForm.querySelector('button[type="submit"]'); // Get the submit button for debt form

            const fixedExpenseForm = document.getElementById('fixedExpenseForm');
            const expenseNameInput = document.getElementById('expenseName');
            const expenseAmountInput = document.getElementById('expenseAmount');
            const expenseFrequencySelect = document.getElementById('expenseFrequency');
            const fixedExpenseList = document.getElementById('fixedExpenseList');
            const addFixedExpenseBtn = fixedExpenseForm.querySelector('button[type="submit"]'); // Get the submit button for fixed expense form

            const monthlyIncomeAmountInput = document.getElementById('monthlyIncomeAmount');
            const incomeFrequencySelect = document.getElementById('incomeFrequency');
            const saveIncomeBtn = document.getElementById('saveIncomeBtn');

            const totalDebtsElement = document.getElementById('totalDebts');
            const availableMoneyElement = document.getElementById('availableMoney');
            const debtPercentageElement = document.getElementById('debtPercentage');
            const debtProgressBar = document.getElementById('debtProgressBar');
            const debtProgressText = document.getElementById('debtProgressText');

            const targetTermMonthsInput = document.getElementById('targetTermMonths');
            const calculateSavingsBtn = document.getElementById('calculateSavingsBtn');
            const dailySavingsElement = document.getElementById('dailySavings');
            const biWeeklySavingsElement = document.getElementById('biWeeklySavings');

            const quickAvailableElement = document.getElementById('quickAvailable');
            const quickDebtsElement = document.getElementById('quickDebts');

            const filterCategorySelect = document.getElementById('filterCategory');
            const filterStatusSelect = document.getElementById('filterStatus');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const clearAllDebtsBtn = document.getElementById('clearAllDebtsBtn');

            const categoryAnalysisBtn = document.getElementById('categoryAnalysisBtn');
            const statisticsBtn = document.getElementById('statisticsBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const resetAllDataBtn = document.getElementById('resetAllDataBtn'); // Nuevo botón para resetear todo

            const debtAmountError = document.getElementById('debtAmountError');
            const termInMonthsError = document.getElementById('termInMonthsError');
            const incomeAmountError = document.getElementById('incomeAmountError');
            const expenseAmountError = document.getElementById('expenseAmountError');
            const targetTermMonthsError = document.getElementById('targetTermMonthsError');

            // Context Menu
            const contextMenu = document.getElementById('contextMenu');
            let currentDebtIdForContext = null;

            // Estrategias de pago de deudas
            const monthlySavingsSlider = document.getElementById('monthlySavingsSlider');
            const savingsValueDisplay = document.getElementById('savingsValue');
            const strategyComparisonDiv = document.getElementById('strategyComparison');
            const showSnowballPlanBtn = document.getElementById('showSnowballPlan');
            const showAvalanchePlanBtn = document.getElementById('showAvalanchePlan');
            const monthlyPlanResultsDiv = document.getElementById('monthlyPlanResults');

            // Simulador de escenarios
            const incomeChangeSlider = document.getElementById('incomeChange');
            const incomeChangeValueDisplay = document.getElementById('incomeChangeValue');
            const expenseChangeSlider = document.getElementById('expenseChange');
            const expenseChangeValueDisplay = document.getElementById('expenseChangeValue');
            const runSimulationBtn = document.getElementById('runSimulation');
            const simulationResultsDiv = document.getElementById('simulationResults');
            const scenarioComparisonDiv = document.getElementById('scenarioComparison');

            // Individual Debt Plan Modal elements
            const individualPlanModal = document.getElementById('individualPlanModal');
            const closeIndividualPlanModalBtn = document.getElementById('closeIndividualPlanModal');
            const modalDebtName = document.getElementById('modalDebtName');
            const modalDebtAmount = document.getElementById('modalDebtAmount');
            const modalTermInMonths = document.getElementById('modalTermInMonths');
            const modalMonthlyPayment = document.getElementById('modalMonthlyPayment');
            const extraPaymentAmountInput = document.getElementById('extraPaymentAmount');
            const extraPaymentError = document.getElementById('extraPaymentError');
            const recalculatePlanBtn = document.getElementById('recalculatePlanBtn');
            const amortizationTableBody = document.getElementById('amortizationTableBody');
            const amortizationSummary = document.getElementById('amortizationSummary');
            const summaryMonths = document.getElementById('summaryMonths');
            const summaryTotalInterest = document.getElementById('summaryTotalInterest');

            let activeDebtForIndividualPlan = null; // Stores the debt object being viewed in the modal

            // Gemini API elements
            const getGeminiStrategyBtn = document.getElementById('getGeminiStrategyBtn');
            const geminiButtonText = document.getElementById('geminiButtonText');
            const geminiLoadingSpinner = document.getElementById('geminiLoadingSpinner');
            const geminiStrategyOutput = document.getElementById('geminiStrategyOutput');

            // New LLM Feature: Quick Financial Advisor
            const financialQuestionInput = document.getElementById('financialQuestion');
            const getAiAdviceBtn = document.getElementById('getAiAdviceBtn');
            const aiAdviceButtonText = document.getElementById('aiAdviceButtonText');
            const aiAdviceLoadingSpinner = document.getElementById('aiAdviceLoadingSpinner');
            const aiAdviceOutput = document.getElementById('aiAdviceOutput');

            // Modal for confirmation
            const confirmationModal = document.getElementById('confirmationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const closeConfirmationModalBtn = document.getElementById('closeConfirmationModal');


            // --- Configuración de Monedas ---
            const CURRENCIES = {
                'USD': { symbol: '$', name: 'Dólar Estadounidense', locale: 'en-US' },
                'ARS': { symbol: '$', name: 'Peso Argentino', locale: 'es-AR' },
                'MXN': { symbol: '$', name: 'Peso Mexicano', locale: 'es-MX' },
                'EUR': { symbol: '€', name: 'Euro', locale: 'es-ES' },
                'COP': { symbol: '$', name: 'Peso Colombiano', locale: 'es-CO' }
            };

            let currentCurrencyCode = localStorage.getItem('selectedCurrency') || 'USD'; // Carga la moneda guardada o USD por defecto
            const currencySelect = document.getElementById('currencySelect');


            // --- Funciones de Utilidad ---
            function formatCurrency(amount) {
                const currency = CURRENCIES[currentCurrencyCode];
                return new Intl.NumberFormat(currency.locale, {
                    style: 'currency',
                    currency: currentCurrencyCode,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2,
                }).format(amount);
            }

            function parseCurrency(currencyString) {
                // Elimina el símbolo de moneda, los puntos de mil y reemplaza la coma decimal por punto
                // Adapta para diferentes separadores decimales si es necesario, por ahora asume ',' como decimal
                const cleanedString = String(currencyString).replace(new RegExp(`[${CURRENCIES[currentCurrencyCode].symbol}.]`, 'g'), '').replace(',', '.');
                return parseFloat(cleanedString) || 0;
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                try {
                    return new Date(dateString + 'T00:00:00').toLocaleDateString(CURRENCIES[currentCurrencyCode].locale, options);
                } catch (e) {
                    console.error("Error formatting date:", dateString, e);
                    return 'Fecha inválida';
                }
            }

            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = message; // Usar innerHTML para permitir negritas y otros estilos
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3500);
            }

            // Custom Modal Function (replaces alert/confirm for better UX)
            function showModal({ title, message, type = 'info', onConfirm, onCancel }) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');

                const confirmHandler = () => {
                    onConfirm();
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    closeConfirmationModalBtn.removeEventListener('click', cancelHandler);
                };

                const cancelHandler = () => {
                    if (onCancel) onCancel();
                    confirmationModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    closeConfirmationModalBtn.removeEventListener('click', cancelHandler);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
                closeConfirmationModalBtn.addEventListener('click', cancelHandler);
            }


            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function loadData(key, defaultValue) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            }

            function saveDataToLocalStorage(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            function validateNumericInput(inputElement, errorElement, allowZero = true, maxDigits = 12) {
                // Limpiar el valor para la validación: eliminar puntos de mil y reemplazar coma decimal por punto.
                const value = inputElement.value.replace(/\./g, '').replace(',', '.');
                const numValue = parseFloat(value);
                const isNumeric = !isNaN(numValue) && isFinite(numValue);
                
                let isValid = isNumeric && (allowZero ? numValue >= 0 : numValue > 0);
                
                if (inputElement.id === 'termInMonths' || inputElement.id === 'targetTermMonths') {
                    isValid = isValid && Number.isInteger(numValue) && numValue.toString().length <= maxDigits;
                    if (!Number.isInteger(numValue)) {
                        errorElement.textContent = `El plazo debe ser un número entero.`;
                    } else {
                        errorElement.textContent = `El plazo debe ser un número entero positivo y no exceder los ${maxDigits} dígitos.`;
                    }
                } else { // Para montos monetarios
                    const integerPart = value.split('.')[0];
                    isValid = isValid && integerPart.length <= maxDigits;
                    errorElement.textContent = `El monto debe ser un número positivo y no exceder los ${maxDigits} dígitos.`;
                }

                if (!isValid) {
                    inputElement.classList.add('input-error');
                    errorElement.classList.remove('hidden');
                    return false;
                } else {
                    inputElement.classList.remove('input-error');
                    errorElement.classList.add('hidden');
                    return true;
                }
            }

            /**
             * Formatea el valor de un input como moneda en tiempo real,
             * manejando el punto de mil y la coma decimal, y el cursor.
             * @param {HTMLInputElement} inputElement El elemento input a formatear.
             */
            function formatInputAsCurrencyLive(inputElement) {
                let value = inputElement.value;
                const cursorPosition = inputElement.selectionStart;

                const originalLength = value.length;

                let cleanedValue = value.replace(/\./g, ''); 
                
                let decimalSeparatorIndex = cleanedValue.indexOf(',');
                if (decimalSeparatorIndex !== -1) {
                    cleanedValue = cleanedValue.substring(0, decimalSeparatorIndex) + '.' + cleanedValue.substring(decimalSeparatorIndex + 1).replace(/,/g, '');
                }
                
                cleanedValue = cleanedValue.replace(/[^0-9.]/g, '');

                const parts = cleanedValue.split('.');
                if (parts.length > 2) {
                    cleanedValue = parts[0] + '.' + parts.slice(1).join('');
                }

                if (cleanedValue.length > 1 && cleanedValue.startsWith('0') && !cleanedValue.startsWith('0.')) {
                    cleanedValue = cleanedValue.substring(1);
                }
                
                if (cleanedValue === '') {
                    inputElement.value = '';
                    return;
                }

                let numValue = parseFloat(cleanedValue);

                if (isNaN(numValue)) {
                    inputElement.value = ''; 
                    return;
                }

                let formattedValue = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 20 
                }).format(numValue);

                if (value.includes(',') && !formattedValue.includes(',')) {
                    const originalDecimalPart = value.substring(value.indexOf(',') + 1);
                    formattedValue += ',' + originalDecimalPart;
                } else if (value.endsWith(',') && !formattedValue.endsWith(',')) {
                    formattedValue += ',';
                }

                inputElement.value = formattedValue;

                const newLength = formattedValue.length;
                const diff = newLength - originalLength;
                inputElement.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
            }

            function updateCurrencySymbolInInputs() {
                const symbol = CURRENCIES[currentCurrencyCode].symbol;
                document.querySelectorAll('.currency-input-wrapper').forEach(wrapper => {
                    wrapper.setAttribute('data-currency-symbol', symbol);
                });
            }


            // --- Funciones de Cálculo Financiero ---

            // Función para calcular la cuota mensual de una deuda (sin intereses)
            const calculateMonthlyPayment = (principal, termInMonths) => {
                if (principal <= 0 || termInMonths <= 0) return 0;
                return principal / termInMonths;
            };

            const calculateFinancialSummary = () => {
                const totalDebt = debts.filter(d => d.status === 'Pendiente').reduce((sum, debt) => sum + debt.amount, 0);
                const totalFixedExpenses = fixedExpenses.reduce((sum, expense) => {
                    let monthlyEquivalent = 0;
                    switch (expense.frequency) {
                        case 'Mensual': monthlyEquivalent = expense.amount; break;
                        case 'Quincenal': monthlyEquivalent = expense.amount * 2; break;
                        case 'Semanal': monthlyEquivalent = expense.amount * 4; break; // Aproximado
                        case 'Anual': monthlyEquivalent = expense.amount / 12; break;
                    }
                    return sum + monthlyEquivalent;
                }, 0);

                let actualMonthlyIncome = 0;
                if (incomeFrequency === 'Mensual') {
                    actualMonthlyIncome = monthlyIncome;
                } else if (incomeFrequency === 'Quincenal') {
                    actualMonthlyIncome = monthlyIncome * 2;
                }

                const monthlyDebtPayments = debts.filter(d => d.status === 'Pendiente').reduce((sum, debt) => {
                    const principal = debt.amount;
                    const termInMonths = debt.termInMonths || 1; 
                    return sum + calculateMonthlyPayment(principal, termInMonths);
                }, 0);

                const totalMonthlyOutgoings = totalFixedExpenses + monthlyDebtPayments;
                const available = actualMonthlyIncome - totalMonthlyOutgoings;
                const debtPercentage = actualMonthlyIncome > 0 ? (totalDebt / actualMonthlyIncome) * 100 : 0;

                totalDebtsElement.textContent = formatCurrency(totalDebt);
                availableMoneyElement.textContent = formatCurrency(available);
                availableMoneyElement.className = `text-2xl font-bold ${available >= 0 ? 'text-purple-900' : 'text-red-600'}`;
                debtPercentageElement.textContent = `${debtPercentage.toFixed(2)} %`;
                debtPercentageElement.className = `text-2xl font-bold ${debtPercentage <= 30 ? 'text-green-900' : debtPercentage <= 60 ? 'text-yellow-800' : 'text-red-900'}`;

                const progress = (totalDebt / (totalDebt + (actualMonthlyIncome || 1))) * 100; // Evitar división por cero
                debtProgressBar.style.width = `${Math.min(100, Math.max(0, progress))} %`;
                debtProgressText.textContent = `${Math.min(100, Math.max(0, progress)).toFixed(2)}%`;

                quickAvailableElement.textContent = formatCurrency(available);
                quickAvailableElement.className = `font-medium ${available >= 0 ? 'text-green-600' : 'text-red-600'}`;
                quickDebtsElement.textContent = formatCurrency(totalDebt);
                quickDebtsElement.className = `font-medium ${totalDebt > 0 ? 'text-red-600' : 'text-green-600'}`;

                return { totalDebt, actualMonthlyIncome, available, totalFixedExpenses, monthlyDebtPayments };
            };

            const calculateIndividualDebtSavings = (debtAmount, termInMonths) => {
                if (debtAmount <= 0 || termInMonths <= 0) {
                    return { daily: 0, biWeekly: 0 };
                }
                const monthlyPayment = calculateMonthlyPayment(debtAmount, termInMonths);
                
                const daily = monthlyPayment / 30.44;
                const biWeekly = monthlyPayment / 2;

                return { daily: daily, biWeekly: biWeekly };
            };

            const calculateGlobalSavingsNeeded = () => {
                const { totalDebt, actualMonthlyIncome, available, totalFixedExpenses, monthlyDebtPayments } = calculateFinancialSummary();
                const targetTermMonths = parseFloat(targetTermMonthsInput.value) || 12;

                if (!validateNumericInput(targetTermMonthsInput, targetTermMonthsError, false, 3)) { // Max 3 digits for months
                    dailySavingsElement.textContent = formatCurrency(0);
                    biWeeklySavingsElement.textContent = formatCurrency(0);
                    return;
                }

                if (totalDebt <= 0) {
                    dailySavingsElement.textContent = formatCurrency(0);
                    biWeeklySavingsElement.textContent = formatCurrency(0);
                    return;
                }

                const requiredMonthlyToClearDebt = totalDebt / targetTermMonths;
                const currentMonthlySurplus = actualMonthlyIncome - (totalFixedExpenses + monthlyDebtPayments);
                
                let additionalMonthlySavingNeeded = 0;
                if (requiredMonthlyToClearDebt > currentMonthlySurplus) {
                    additionalMonthlySavingNeeded = requiredMonthlyToClearDebt - currentMonthlySurplus;
                }
                
                const daily = additionalMonthlySavingNeeded / 30.44;
                const biWeekly = additionalMonthlySavingNeeded / 2;

                dailySavingsElement.textContent = formatCurrency(daily);
                biWeeklySavingsElement.textContent = formatCurrency(biWeekly);
            };

            // --- Estrategias de Pago (Bola de Nieve / Avalancha) ---
            const PAYMENT_STRATEGIES = {
                SNOWBALL: 'Bola de Nieve',
                AVALANCHE: 'Avalancha'
            };

            function calculatePayoffStrategy(debtsToConsider, monthlySavings, strategy) {
                // Clonar deudas para no modificar el array original
                let remainingDebts = debtsToConsider
                    .filter(d => d.status === 'Pendiente')
                    .map(d => ({ ...d, currentAmount: d.amount })); // Usar currentAmount para la simulación

                if (remainingDebts.length === 0) {
                    return { success: true, monthsNeeded: 0, totalInterest: 0, payoffPlan: [] };
                }

                // Ordenar según estrategia (sin intereses)
                if (strategy === PAYMENT_STRATEGIES.SNOWBALL) {
                    remainingDebts.sort((a, b) => a.currentAmount - b.currentAmount); // Menor monto primero
                } else { // Avalanche (mayor monto primero, sin intereses)
                    remainingDebts.sort((a, b) => b.currentAmount - a.currentAmount); // Mayor monto primero
                }

                let months = 0;
                let totalInterestPaid = 0; // Se mantiene para compatibilidad, pero siempre será 0
                const payoffPlan = [];

                // Simulación mes a mes
                while (remainingDebts.some(d => d.currentAmount > 0) && months < 360) { // Máximo 30 años (360 meses)
                    months++;
                    let currentMonthSavings = monthlySavings;
                    const monthResult = { month: months, payments: [], totalPaidThisMonth: 0 };

                    // Aplicar pagos mínimos (sin intereses)
                    remainingDebts.forEach(debt => {
                        if (debt.currentAmount <= 0) return;

                        const minimumPayment = calculateMonthlyPayment(debt.amount, debt.termInMonths); // Base payment from original principal
                        const actualMinPayment = Math.min(minimumPayment, debt.currentAmount);
                        
                        debt.minPaymentDue = actualMinPayment;
                    });

                    // Pagar deudas en orden, usando el ahorro disponible
                    for (let i = 0; i < remainingDebts.length; i++) {
                        let debt = remainingDebts[i];
                        if (debt.currentAmount <= 0) continue; 

                        let paymentTowardsPrincipal = 0;
                        if (currentMonthSavings > 0) {
                            const payment = Math.min(currentMonthSavings, debt.currentAmount);
                            paymentTowardsPrincipal = payment;
                            debt.currentAmount -= payment;
                            currentMonthSavings -= payment;
                            monthResult.totalPaidThisMonth += payment;

                            monthResult.payments.push({
                                debt: debt.name,
                                payment: payment,
                                remaining: debt.currentAmount,
                                paidOff: debt.currentAmount <= 0
                            });
                        } else {
                            monthResult.payments.push({
                                debt: debt.name,
                                payment: 0, 
                                remaining: debt.currentAmount,
                                paidOff: false
                            });
                        }
                    }
                    
                    remainingDebts = remainingDebts.filter(d => d.currentAmount > 0);
                    payoffPlan.push(monthResult);
                }

                const success = remainingDebts.length === 0 || remainingDebts.every(d => d.currentAmount <= 0);

                return {
                    strategy,
                    monthsNeeded: months,
                    totalInterest: totalInterestPaid, 
                    payoffPlan,
                    success
                };
            }

            function compareStrategies() {
                const monthlySavings = parseCurrency(monthlySavingsSlider.value);
                const pendingDebts = debts.filter(d => d.status === 'Pendiente');
                
                if (pendingDebts.length === 0) {
                    strategyComparisonDiv.innerHTML = `
                        <div class="col-span-2 p-4 bg-green-50 text-green-800 rounded-lg border border-green-200">
                            ¡No tienes deudas pendientes que pagar!
                        </div>
                    `;
                    monthlyPlanResultsDiv.innerHTML = '<p class="text-gray-600">No hay deudas pendientes para planificar.</p>';
                    return;
                }

                const snowball = calculatePayoffStrategy(pendingDebts, monthlySavings, PAYMENT_STRATEGIES.SNOWBALL);
                const avalanche = calculatePayoffStrategy(pendingDebts, monthlySavings, PAYMENT_STRATEGIES.AVALANCHE);

                renderStrategyResult(snowball, avalanche);
                // Mostrar el plan de bola de nieve por defecto al cargar
                monthlyPlanResultsDiv.innerHTML = generateMonthlyPlanHTML(snowball);
            }

            function renderStrategyResult(snowball, avalanche) {
                const bestStrategy = snowball.monthsNeeded < avalanche.monthsNeeded ? snowball : avalanche;
                
                let html = `
                    <div class="bg-white p-4 rounded-lg border ${bestStrategy.strategy === PAYMENT_STRATEGIES.SNOWBALL ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                        <h4 class="font-bold ${bestStrategy.strategy === PAYMENT_STRATEGIES.SNOWBALL ? 'text-blue-800' : 'text-purple-800'}">${snowball.strategy}</h4>
                        <p class="my-2"><span class="font-semibold">Tiempo:</span> ${snowball.monthsNeeded} meses</p>
                        <p class="my-2"><span class="font-semibold">Interés total:</span> ${formatCurrency(snowball.totalInterest)}</p>
                        ${snowball.success ? '' : '<p class="text-red-500 text-sm">⚠️ No suficiente para pagar todas las deudas</p>'}
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border ${bestStrategy.strategy === PAYMENT_STRATEGIES.AVALANCHE ? 'border-blue-300 bg-blue-50' : 'border-purple-300 bg-purple-50'}">
                        <h4 class="font-bold ${bestStrategy.strategy === PAYMENT_STRATEGIES.AVALANCHE ? 'text-blue-800' : 'text-purple-800'}">${avalanche.strategy}</h4>
                        <p class="my-2"><span class="font-semibold">Tiempo:</span> ${avalanche.monthsNeeded} meses</p>
                        <p class="my-2"><span class="font-semibold">Interés total:</span> ${formatCurrency(avalanche.totalInterest)}</p>
                        ${avalanche.success ? '' : '<p class="text-red-500 text-sm">⚠️ No suficiente para pagar todas las deudas</p>'}
                    </div>
                    
                    <div class="md:col-span-2 p-4 bg-yellow-50 border border-yellow-200 rounded-lg mt-2">
                        <p class="font-semibold text-yellow-800">💡 Recomendación:</p>
                        <p>Con <span class="font-bold">${formatCurrency(parseCurrency(monthlySavingsSlider.value))}/mes</span>, 
                        la estrategia <span class="font-bold">"${bestStrategy.strategy}"</span> te permite ${
                            bestStrategy.success ? 
                            `liquidar tus deudas en <span class="font-bold">${bestStrategy.monthsNeeded} meses</span> pagando <span class="font-bold">${formatCurrency(bestStrategy.totalInterest)}</span> en intereses.` : 
                            'reducir tus deudas pero no liquidarlas completamente con tu ahorro actual.'
                        }</p>
                    </div>
                `;
                strategyComparisonDiv.innerHTML = html;
            }

            function generateMonthlyPlanHTML(result) {
                if (!result.success) {
                    return `
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg text-red-800">
                            <p class="font-semibold">⚠️ Plan incompleto</p>
                            <p>Con tu ahorro actual de ${formatCurrency(parseCurrency(monthlySavingsSlider.value))}/mes no es posible liquidar todas las deudas usando esta estrategia.</p>
                            <p class="mt-2">Intenta aumentar tu ahorro mensual para ver un plan completo.</p>
                        </div>
                    `;
                }

                let html = `
                    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <p class="font-semibold text-green-800">📌 Resumen del Plan (${result.strategy}):</p>
                        <p>Podrías liquidar <span class="font-bold">${debts.filter(d => d.status === 'Pendiente').length} deudas</span> en <span class="font-bold">${result.monthsNeeded} meses</span> 
                        pagando <span class="font-bold">${formatCurrency(result.totalInterest)}</span> en intereses.</p>
                    </div>
                    
                    <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                        <table class="min-w-full bg-white monthly-plan-table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left">Mes</th>
                                    <th class="px-4 py-2 text-left">Deuda</th>
                                    <th class="px-4 py-2 text-right">Pago</th>
                                    <th class="px-4 py-2 text-right">Saldo Restante</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyPlanDetails">
                `;

                const monthsToShow = result.payoffPlan.slice(0, 12); // Mostrar solo los primeros 12 meses
                
                monthsToShow.forEach(month => {
                    month.payments.forEach((payment, index) => {
                        const isFirstPayment = index === 0;
                        html += `
                            <tr class="${isFirstPayment ? 'border-t border-gray-100' : ''}">
                                ${isFirstPayment ? `<td rowspan="${month.payments.length}" class="px-4 py-2 border-r border-gray-100 align-top">Mes ${month.month}</td>` : ''}
                                <td class="px-4 py-2">${payment.debt}</td>
                                <td class="px-4 py-2 text-right">${formatCurrency(payment.payment)}</td>
                                <td class="px-4 py-2 text-right">${payment.remaining > 0 ? formatCurrency(payment.remaining) : '<span class="text-green-600">¡Pagada!</span>'}</td>
                            </tr>
                        `;
                    });
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                if (result.payoffPlan.length > 12) {
                    html += `
                        <div class="mt-3 text-sm text-gray-600">
                            <p>+ ${result.payoffPlan.length - 12} meses adicionales no mostrados...</p>
                        </div>
                    `;
                }

                return html;
            }

            // --- Simulador de Escenarios ---
            function runScenarioSimulation() {
                const incomeChange = parseInt(incomeChangeSlider.value) / 100;
                const expenseChange = parseInt(expenseChangeSlider.value) / 100;
                
                const currentIncome = monthlyIncome * (incomeFrequency === 'Quincenal' ? 2 : 1);
                const currentFixedExpenses = fixedExpenses.reduce((sum, exp) => {
                    let monthlyEquivalent = 0;
                    switch (exp.frequency) {
                        case 'Mensual': monthlyEquivalent = exp.amount; break;
                        case 'Quincenal': monthlyEquivalent = exp.amount * 2; break;
                        case 'Semanal': monthlyEquivalent = exp.amount * 4; break;
                        case 'Anual': monthlyEquivalent = exp.amount / 12; break;
                    }
                    return sum + monthlyEquivalent;
                }, 0);
                const currentMonthlyDebtPayments = debts.filter(d => d.status === 'Pendiente').reduce((sum, debt) => {
                    return sum + calculateMonthlyPayment(debt.amount, debt.termInMonths);
                }, 0);

                const currentTotalOutgoings = currentFixedExpenses + currentMonthlyDebtPayments;
                const currentNetAvailable = currentIncome - currentTotalOutgoings;

                const simulatedIncome = currentIncome * (1 + incomeChange);
                const simulatedFixedExpenses = currentFixedExpenses * (1 + expenseChange);
                const simulatedTotalOutgoings = simulatedFixedExpenses + currentMonthlyDebtPayments;
                const simulatedNetAvailable = simulatedIncome - simulatedTotalOutgoings;

                let html = `
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h5 class="font-semibold mb-2">Situación Actual</h5>
                        <p><span class="font-medium">Ingresos Mensuales:</span> ${formatCurrency(currentIncome)}</p>
                        <p><span class="font-medium">Gastos Fijos Mensuales:</span> ${formatCurrency(currentFixedExpenses)}</p>
                        <p><span class="font-medium">Pagos Deuda Mensuales:</span> ${formatCurrency(currentMonthlyDebtPayments)}</p>
                        <p class="mt-2"><span class="font-medium">Dinero Disponible Neto:</span> ${formatCurrency(currentNetAvailable)}</p>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h5 class="font-semibold mb-2">Escenario Simulado</h5>
                        <p><span class="font-medium">Ingresos Mensuales:</span> ${formatCurrency(simulatedIncome)} <span class="text-sm ${incomeChange > 0 ? 'text-green-600' : incomeChange < 0 ? 'text-red-600' : ''}">(${incomeChange > 0 ? '+' : ''}${incomeChange * 100}%)</span></p>
                        <p><span class="font-medium">Gastos Fijos Mensuales:</span> ${formatCurrency(simulatedFixedExpenses)} <span class="text-sm ${expenseChange < 0 ? 'text-green-600' : expenseChange > 0 ? 'text-red-600' : ''}">(${expenseChange > 0 ? '+' : ''}${expenseChange * 100}%)</span></p>
                        <p><span class="font-medium">Pagos Deuda Mensuales:</span> ${formatCurrency(currentMonthlyDebtPayments)}</p>
                        <p class="mt-2"><span class="font-medium">Dinero Disponible Neto:</span> ${formatCurrency(simulatedNetAvailable)}</p>
                    </div>
                    
                    <div class="md:col-span-2 p-4 rounded-lg mt-2 ${simulatedNetAvailable >= currentNetAvailable ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}">
                        <p class="font-semibold">${simulatedNetAvailable >= currentNetAvailable ? '✅ Mejora' : '⚠️ Empeora'}:</p>
                        <p>${formatCurrency(Math.abs(simulatedNetAvailable - currentNetAvailable))} ${simulatedNetAvailable >= currentNetAvailable ? 'más' : 'menos'} disponible por mes.</p>
                    </div>
                    <div class="md:col-span-2 p-4 bg-blue-50 rounded-lg border border-blue-200 mt-2">
                        <h5 class="font-semibold text-blue-800 mb-2">Recomendación para este escenario:</h5>
                        <p>${getScenarioRecommendation(incomeChange, expenseChange, simulatedNetAvailable - currentNetAvailable)}</p>
                    </div>
                `;
                
                scenarioComparisonDiv.innerHTML = html;
                simulationResultsDiv.classList.remove('hidden');
            }

            function getScenarioRecommendation(incomeChange, expenseChange, netDifference) {
                if (netDifference > 0) {
                    if (incomeChange > 0 && expenseChange <= 0) {
                        return `¡Excelente! Este escenario mejora tu situación financiera. Un aumento de ingresos combinado con una reducción o mantenimiento de gastos es ideal.`;
                    } else if (incomeChange > 0) {
                        return `Un aumento de ingresos siempre ayuda. Sigue buscando oportunidades para crecer tus ingresos.`;
                    } else if (expenseChange < 0) {
                        return `Reducir tus gastos tiene un impacto positivo directo. Identifica más áreas donde puedas ahorrar.`;
                    } else {
                        return `Este escenario es positivo. Mantén el enfoque en optimizar tanto ingresos como gastos.`;
                    }
                } else if (netDifference < 0) {
                    if (incomeChange < 0 && expenseChange >= 0) {
                        return `¡Cuidado! Una reducción de ingresos sin ajuste de gastos puede ser peligrosa. Busca formas de mantener tus ingresos o reducir drásticamente tus gastos.`;
                    } else if (expenseChange > 0) {
                        return `Un aumento de gastos sin un incremento de ingresos puede llevar a problemas. Revisa tus hábitos de gasto.`;
                    } else {
                        return `Este escenario es desfavorable. Es crucial que tomes medidas para aumentar ingresos o reducir gastos para evitar un déficit.`;
                    }
                } else {
                    return `Este escenario no presenta cambios significativos. Para mejorar tu salud financiera, considera ajustes más grandes.`;
                }
            }

            // --- Sistema de Alertas Automáticas ---
            function checkFinancialHealth() {
                const normalizedIncome = monthlyIncome * (incomeFrequency === 'Quincenal' ? 2 : 1);
                const totalPendingDebts = debts.filter(d => d.status === 'Pendiente').reduce((sum, d) => sum + d.amount, 0);
                
                const totalFixedExpenses = fixedExpenses.reduce((sum, exp) => {
                    let monthlyEquivalent = 0;
                    switch (exp.frequency) {
                        case 'Mensual': monthlyEquivalent = exp.amount; break;
                        case 'Quincenal': monthlyEquivalent = exp.amount * 2; break;
                        case 'Semanal': monthlyEquivalent = exp.amount * 4; break;
                        case 'Anual': monthlyEquivalent = exp.amount / 12; break;
                    }
                    return sum + monthlyEquivalent;
                }, 0);
                const monthlyDebtPaymentsSum = debts.filter(d => d.status === 'Pendiente').reduce((sum, debt) => {
                    return sum + calculateMonthlyPayment(debt.amount, debt.termInMonths);
                }, 0);

                const debtToIncomeRatio = normalizedIncome > 0 ? (totalPendingDebts / normalizedIncome) : 0;
                const expensesToIncomeRatio = normalizedIncome > 0 ? (totalFixedExpenses / normalizedIncome) : 0;
                const totalOutgoingsRatio = normalizedIncome > 0 ? ((totalFixedExpenses + monthlyDebtPaymentsSum) / normalizedIncome) : 0;
                
                const alerts = [];
                
                if (normalizedIncome === 0) {
                    alerts.push({ type: 'warning', message: `📊 <span class="font-bold">Ingresos no definidos</span>: Para un análisis completo, por favor, ingresa tus ingresos mensuales.` });
                }

                if (debtToIncomeRatio > 0.6) { // Deuda > 60% de ingresos anuales (simplificado a mensual * 12)
                    alerts.push({
                        type: 'danger',
                        message: `⚠️ <span class="font-bold">Alto riesgo de deuda</span>: Tus deudas pendientes (${formatCurrency(totalPendingDebts)}) representan el <span class="font-bold">${Math.round(debtToIncomeRatio * 100)}%</span> de tus ingresos mensuales. Considera un plan de acción.`
                    });
                } else if (debtToIncomeRatio > 0.3) {
                    alerts.push({
                        type: 'warning',
                        message: `📈 <span class="font-bold">Nivel de deuda moderado</span>: Tus deudas están en un ${Math.round(debtToIncomeRatio * 100)}% de tus ingresos. Mantén un ojo en ellas.`
                    });
                }
                
                if (totalOutgoingsRatio > 0.8) { // Gastos fijos + pagos de deuda > 80% de ingresos
                    alerts.push({
                        type: 'danger',
                        message: `🚨 <span class="font-bold">Gastos descontrolados</span>: Tus gastos fijos y pagos de deudas (${formatCurrency(totalFixedExpenses + monthlyDebtPaymentsSum)}) consumen el <span class="font-bold">${Math.round(totalOutgoingsRatio * 100)}%</span> de tus ingresos. ¡Necesitas ajustar tu presupuesto urgentemente!`
                    });
                } else if (totalOutgoingsRatio > 0.6) {
                    alerts.push({
                        type: 'warning',
                        message: `💸 <span class="font-bold">Margen ajustado</span>: Tus gastos y pagos de deudas consumen el ${Math.round(totalOutgoingsRatio * 100)}% de tus ingresos. Tienes poco margen para el ahorro o imprevistos.`
                    });
                }

                // Regla: Deudas con vencimiento próximo
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                debts.filter(d => d.status === 'Pendiente').forEach(debt => {
                    const dueDate = new Date(debt.dueDate + 'T00:00:00'); // Asegurar zona horaria
                    if (dueDate <= nextWeek && dueDate >= today) {
                        alerts.push({
                            type: 'danger',
                            message: `⏰ <span class="font-bold">Vencimiento próximo</span>: La deuda "${debt.name}" por ${formatCurrency(debt.amount)} vence el ${formatDate(debt.dueDate)}.`
                        });
                    } else if (dueDate < today) {
                        alerts.push({
                            type: 'danger',
                            message: `🔴 <span class="font-bold">Deuda vencida</span>: La deuda "${debt.name}" por ${formatCurrency(debt.amount)} venció el ${formatDate(debt.dueDate)}. ¡Actúa ahora!`
                        });
                    }
                });

                displayAlerts(alerts);
            }

            function displayAlerts(alerts) {
                const oldAlerts = document.getElementById('financialAlerts');
                if (oldAlerts) oldAlerts.remove();
                
                if (alerts.length === 0) return;

                const alertsContainer = document.createElement('div');
                alertsContainer.id = 'financialAlerts';
                alertsContainer.className = 'fixed bottom-4 left-4 right-4 max-w-md mx-auto z-50 space-y-2';
                
                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `p-3 rounded-lg shadow-lg border-l-4 ${getAlertClass(alert.type)}`;
                    alertDiv.innerHTML = alert.message;
                    alertsContainer.appendChild(alertDiv);
                });
                
                document.body.appendChild(alertsContainer);
                
                setTimeout(() => {
                    alertsContainer.style.opacity = '0';
                    setTimeout(() => alertsContainer.remove(), 500);
                }, 10000);
            }

            function getAlertClass(type) {
                const classes = {
                    danger: 'bg-red-50 border-red-500 text-red-800',
                    warning: 'bg-yellow-50 border-yellow-500 text-yellow-800',
                    info: 'bg-blue-50 border-blue-500 text-blue-800',
                    success: 'bg-green-50 border-green-500 text-green-800'
                };
                return classes[type] || classes.info;
            }


            // --- Renderizado de Listas ---

            const renderDebts = (filteredDebts = debts) => {
                debtList.innerHTML = '';

                if (filteredDebts.length === 0) {
                    debtList.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">No hay deudas registradas.</td></tr>`;
                    return;
                }

                filteredDebts.sort((a, b) => {
                    if (a.status === 'Pendiente' && b.status === 'Pagada') return -1;
                    if (a.status === 'Pagada' && b.status === 'Pendiente') return 1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });


                filteredDebts.forEach(debt => {
                    const savings = calculateIndividualDebtSavings(debt.amount, debt.termInMonths);
                    const monthlyPayment = calculateMonthlyPayment(debt.amount, debt.termInMonths);

                    const row = document.createElement('tr');
                    row.className = 'new-item';
                    row.dataset.id = debt.id;
                    row.dataset.status = debt.status;

                    let statusClass = '';
                    let statusText = debt.status;
                    if (debt.status === 'Pendiente') {
                        const today = new Date();
                        const dueDate = new Date(debt.dueDate + 'T00:00:00');
                        if (dueDate < today) {
                            statusText = 'Vencida';
                            statusClass = 'text-red-500 font-semibold';
                        } else if ((dueDate - today) / (1000 * 60 * 60 * 24) <= 7) {
                            statusText = 'Próxima a vencer';
                            statusClass = 'text-orange-500 font-semibold';
                        } else {
                            statusText = 'Pendiente';
                            statusClass = 'text-blue-500';
                        }
                    } else if (debt.status === 'Pagada') {
                        statusClass = 'text-green-600 line-through';
                    }

                    row.innerHTML = `
                        <td>${debt.name}</td>
                        <td>${formatCurrency(debt.amount)}</td>
                        <td>${formatCurrency(monthlyPayment)}</td>
                        <td>${formatDate(debt.dueDate)}</td>
                        <td>${debt.category}</td>
                        <td>${debt.termInMonths || 'N/A'}</td>
                        <td>${formatCurrency(savings.daily)}</td>
                        <td>${formatCurrency(savings.biWeekly)}</td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button class="text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out options-btn" data-id="${debt.id}" title="Opciones">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                </svg>
                            </button>
                        </td>
                    `;
                    debtList.appendChild(row);
                });
                
                document.querySelectorAll('.options-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation();
                        currentDebtIdForContext = event.currentTarget.dataset.id;
                        const debt = debts.find(d => d.id === currentDebtIdForContext);

                        const markAsPaidBtn = contextMenu.querySelector('[data-action="markAsPaid"]');
                        if (debt.status === 'Pagada') {
                            markAsPaidBtn.textContent = 'Marcar como pendiente';
                        } else {
                            markAsPaidBtn.textContent = 'Marcar como pagada';
                        }

                        contextMenu.style.left = `${event.pageX}px`;
                        contextMenu.style.top = `${event.pageY}px`;
                        contextMenu.classList.remove('hidden');
                    });
                });
                saveDataToLocalStorage('debts', debts); 
            };

            const renderFixedExpenses = () => {
                fixedExpenseList.innerHTML = '';
                if (fixedExpenses.length === 0) {
                    fixedExpenseList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay gastos fijos registrados.</td></tr>`;
                    return;
                }
                fixedExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.className = 'new-item';
                    row.dataset.id = expense.id;
                    row.innerHTML = `
                        <td>${expense.name}</td>
                        <td>${formatCurrency(expense.amount)}</td>
                        <td>${expense.frequency}</td>
                        <td>
                            <button onclick="editFixedExpense('${expense.id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-150 ease-in-out mr-2">Editar</button>
                            <button onclick="deleteFixedExpense('${expense.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-md transition duration-150 ease-in-out">Eliminar</button>
                        </td>
                    `;
                    fixedExpenseList.appendChild(row);
                });
                saveDataToLocalStorage('fixedExpenses', fixedExpenses); 
            };

            // --- Manejo de Eventos ---

            // Acordeones
            document.querySelectorAll('.accordion-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    const targetPanel = document.querySelector(targetId);
                    
                    document.querySelectorAll('.accordion-content.active').forEach(panel => {
                        if (panel !== targetPanel) {
                            panel.classList.remove('active');
                            panel.previousElementSibling.classList.remove('active');
                            panel.previousElementSibling.style.borderRadius = '1.25rem';
                            panel.style.borderTop = 'none';
                        }
                    });

                    targetPanel.classList.toggle('active');
                    button.classList.toggle('active');

                    if (targetPanel.classList.contains('active')) {
                        button.style.borderRadius = '1.25rem 1.25rem 0 0';
                        targetPanel.style.borderTop = '1px solid #e2e8f0';
                        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                            targetPanel.style.borderTop = '1px solid rgba(60, 60, 65, 0.5)';
                        }
                    } else {
                        button.style.borderRadius = '1.25rem';
                        targetPanel.style.borderTop = 'none';
                    }
                });
            });

            // Formulario de Deudas
            debtForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                console.log('Debt form submitted via click or Enter.');

                const isValidAmount = validateNumericInput(debtAmountInput, debtAmountError, false);
                const isValidTerm = validateNumericInput(termInMonthsInput, termInMonthsError, false, 3);
                
                let allRequiredFieldsFilled = debtForm.checkValidity();

                if (!debtNameInput.value) debtNameInput.classList.add('input-error'); else debtNameInput.classList.remove('input-error');
                if (!dueDateInput.value) dueDateInput.classList.add('input-error'); else dueDateInput.classList.remove('input-error');
                if (!debtCategorySelect.value) debtCategorySelect.classList.add('input-error'); else debtCategorySelect.classList.remove('input-error');


                if (!isValidAmount || !isValidTerm || !allRequiredFieldsFilled) { 
                    showToast('Por favor, completa todos los campos requeridos y corrige los errores.', 'error');
                    return;
                }

                const debtData = {
                    name: debtNameInput.value,
                    amount: parseCurrency(debtAmountInput.value),
                    dueDate: dueDateInput.value,
                    category: debtCategorySelect.value,
                    termInMonths: parseInt(termInMonthsInput.value) || 0, 
                    status: 'Pendiente'
                };

                if (editingDebtId) {
                    const index = debts.findIndex(d => d.id === editingDebtId);
                    if (index !== -1) {
                        debts[index] = { ...debts[index], ...debtData };
                        showToast('Deuda actualizada exitosamente.', 'success');
                    }
                    editingDebtId = null;
                    addDebtBtn.textContent = 'Guardar Deuda';
                    addDebtBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    addDebtBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    debts.push({ id: generateId(), ...debtData });
                    showToast('Deuda agregada exitosamente.', 'success');
                }
                
                debtForm.reset();
                debtNameInput.classList.remove('input-error');
                dueDateInput.classList.remove('input-error');
                debtCategorySelect.classList.remove('input-error');
                updateUI();
            });

            // Edición de Deuda
            window.editDebt = (id) => {
                const debtToEdit = debts.find(d => d.id === id);
                if (debtToEdit) {
                    debtNameInput.value = debtToEdit.name;
                    debtAmountInput.value = parseCurrency(debtToEdit.amount); // Show raw number for editing
                    dueDateInput.value = debtToEdit.dueDate;
                    debtCategorySelect.value = debtToEdit.category;
                    termInMonthsInput.value = debtToEdit.termInMonths;

                    editingDebtId = id;
                    addDebtBtn.textContent = 'Actualizar Deuda';
                    addDebtBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    addDebtBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');

                    const addDebtToggle = document.querySelector('.accordion-toggle[data-target="#addDebtPanel"]');
                    const addDebtPanel = document.getElementById('addDebtPanel');
                    if (!addDebtPanel.classList.contains('active')) {
                        addDebtToggle.click();
                    }
                    addDebtPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // Event listeners para formato en tiempo real y validación
            monthlyIncomeAmountInput.addEventListener('input', () => formatInputAsCurrencyLive(monthlyIncomeAmountInput));
            monthlyIncomeAmountInput.addEventListener('blur', (e) => {
                validateNumericInput(monthlyIncomeAmountInput, incomeAmountError, true);
                const value = parseCurrency(e.target.value);
                if (!isNaN(value)) {
                    e.target.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    }).format(value);
                }
            });
            monthlyIncomeAmountInput.addEventListener('focus', (e) => {
                e.target.value = parseCurrency(e.target.value);
            });

            debtAmountInput.addEventListener('input', () => formatInputAsCurrencyLive(debtAmountInput));
            debtAmountInput.addEventListener('blur', (e) => {
                validateNumericInput(debtAmountInput, debtAmountError, false);
                const value = parseCurrency(e.target.value);
                if (!isNaN(value)) {
                    e.target.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    }).format(value);
                }
            });
            debtAmountInput.addEventListener('focus', (e) => {
                e.target.value = parseCurrency(e.target.value);
            });

            termInMonthsInput.addEventListener('blur', () => {
                validateNumericInput(termInMonthsInput, termInMonthsError, false, 3);
            });


            // Formulario de Gastos Fijos
            fixedExpenseForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                console.log('Fixed expense form submitted via click or Enter.');

                const isValidAmount = validateNumericInput(expenseAmountInput, expenseAmountError, false);

                let allRequiredFieldsFilled = fixedExpenseForm.checkValidity();

                if (!expenseNameInput.value) expenseNameInput.classList.add('input-error'); else expenseNameInput.classList.remove('input-error');
                if (!expenseFrequencySelect.value) expenseFrequencySelect.classList.add('input-error'); else expenseFrequencySelect.classList.remove('input-error');


                if (!isValidAmount || !allRequiredFieldsFilled) {
                    showToast('Por favor, completa todos los campos requeridos y corrige los errores.', 'error');
                    return;
                }

                const expenseData = {
                    name: expenseNameInput.value,
                    amount: parseCurrency(expenseAmountInput.value),
                    frequency: expenseFrequencySelect.value
                };

                if (editingFixedExpenseId) {
                    const index = fixedExpenses.findIndex(e => e.id === editingFixedExpenseId);
                    if (index !== -1) {
                        fixedExpenses[index] = { ...fixedExpenses[index], ...expenseData };
                        showToast('Gasto fijo actualizado exitosamente.', 'success');
                    }
                    editingFixedExpenseId = null;
                    addFixedExpenseBtn.textContent = 'Guardar Gasto Fijo';
                    addFixedExpenseBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    addFixedExpenseBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                } else {
                    fixedExpenses.push({ id: generateId(), ...expenseData });
                    showToast('Gasto fijo agregado exitosamente.', 'success');
                }
                
                fixedExpenseForm.reset();
                expenseNameInput.classList.remove('input-error');
                expenseFrequencySelect.classList.remove('input-error');
                updateUI();
            });

            // Edición de Gasto Fijo
            window.editFixedExpense = (id) => {
                const expenseToEdit = fixedExpenses.find(e => e.id === id);
                if (expenseToEdit) {
                    expenseNameInput.value = expenseToEdit.name;
                    expenseAmountInput.value = parseCurrency(expenseToEdit.amount); // Show raw number for editing
                    expenseFrequencySelect.value = expenseToEdit.frequency;

                    editingFixedExpenseId = id;
                    addFixedExpenseBtn.textContent = 'Actualizar Gasto Fijo';
                    addFixedExpenseBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    addFixedExpenseBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');

                    const fixedExpenseToggle = document.querySelector('.accordion-toggle[data-target="#fixedExpensesPanel"]');
                    const fixedExpensePanel = document.getElementById('fixedExpensesPanel');
                    if (!fixedExpensePanel.classList.contains('active')) {
                        fixedExpenseToggle.click();
                    }
                    fixedExpensePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            expenseAmountInput.addEventListener('input', () => formatInputAsCurrencyLive(expenseAmountInput));
            expenseAmountInput.addEventListener('blur', (e) => {
                validateNumericInput(expenseAmountInput, expenseAmountError, false);
                const value = parseCurrency(e.target.value);
                if (!isNaN(value)) {
                    e.target.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    }).format(value);
                }
            });
            expenseAmountInput.addEventListener('focus', (e) => {
                e.target.value = parseCurrency(e.target.value);
            });

            // Guardar Ingreso
            saveIncomeBtn.addEventListener('click', () => {
                console.log('Save Income button clicked.');
                const isValidAmount = validateNumericInput(monthlyIncomeAmountInput, incomeAmountError, true);

                if (!isValidAmount) {
                    showToast('Por favor, ingresa un monto de ingreso válido.', 'error');
                    return;
                }

                monthlyIncome = parseCurrency(monthlyIncomeAmountInput.value);
                incomeFrequency = incomeFrequencySelect.value;
                saveDataToLocalStorage('monthlyIncome', monthlyIncome);
                saveDataToLocalStorage('incomeFrequency', incomeFrequency);
                updateUI();
                showToast('Ingreso guardado exitosamente.', 'success');
            });


            // Calcular Ahorro Global
            calculateSavingsBtn.addEventListener('click', calculateGlobalSavingsNeeded);
            targetTermMonthsInput.addEventListener('input', () => validateNumericInput(targetTermMonthsInput, targetTermMonthsError, false, 3));
            targetTermMonthsInput.addEventListener('blur', () => {
                validateNumericInput(targetTermMonthsInput, targetTermMonthsError, false, 3);
            });


            // Filtros y Limpiar Deudas
            filterCategorySelect.addEventListener('change', () => {
                const category = filterCategorySelect.value;
                const status = filterStatusSelect.value;
                applyFilters(category, status);
            });

            filterStatusSelect.addEventListener('change', () => {
                const category = filterCategorySelect.value;
                const status = filterStatusSelect.value;
                applyFilters(category, status);
            });

            clearFiltersBtn.addEventListener('click', () => {
                filterCategorySelect.value = 'all';
                filterStatusSelect.value = 'all';
                renderDebts(debts);
                showToast('Filtros de deudas limpiados.', 'info');
            });

            const applyFilters = (category, status) => {
                let filtered = debts;
                if (category !== 'all') {
                    filtered = filtered.filter(debt => debt.category === category);
                }
                if (status !== 'all') {
                    filtered = filtered.filter(debt => debt.status === status);
                }
                renderDebts(filtered);
            };

            clearAllDebtsBtn.addEventListener('click', () => {
                showModal({
                    title: 'Confirmar Eliminación de Deudas',
                    message: '¿Estás seguro de que deseas eliminar TODAS tus deudas? Esta acción no se puede deshacer.',
                    type: 'warning',
                    onConfirm: () => {
                        debts = [];
                        saveDataToLocalStorage('debts', debts);
                        updateUI();
                        showToast('Todas las deudas han sido eliminadas.', 'info');
                    }
                });
            });

            // Funciones de acciones para el menú contextual (globalmente accesibles)
            window.markAsPaid = (id) => {
                const debtIndex = debts.findIndex(d => d.id === id);
                if (debtIndex !== -1) {
                    const debt = debts[debtIndex];
                    if (debt.status === 'Pendiente') {
                        debt.status = 'Pagada';
                        showToast(`Deuda "${debt.name}" marcada como pagada. ¡Felicidades!`, 'success');
                    } else {
                        debt.status = 'Pendiente';
                        showToast(`Deuda "${debt.name}" marcada como pendiente.`, 'info');
                    }
                    updateUI();
                }
                contextMenu.classList.add('hidden');
            };

            window.deleteDebt = (id) => {
                showModal({
                    title: 'Confirmar Eliminación de Deuda',
                    message: '¿Estás seguro de que deseas eliminar esta deuda? Esta acción no se puede deshacer.',
                    type: 'warning',
                    onConfirm: () => {
                        debts = debts.filter(debt => debt.id !== id);
                        updateUI();
                        showToast('Deuda eliminada exitosamente.', 'info');
                    }
                });
                contextMenu.classList.add('hidden');
            };

            window.deleteFixedExpense = (id) => {
                showModal({
                    title: 'Confirmar Eliminación de Gasto Fijo',
                    message: '¿Estás seguro de que deseas eliminar este gasto fijo? Esta acción no se puede deshacer.',
                    type: 'warning',
                    onConfirm: () => {
                        fixedExpenses = fixedExpenses.filter(expense => expense.id !== id);
                        updateUI();
                        showToast('Gasto fijo eliminado exitosamente.', 'info');
                    }
                });
            };

            // Manejo del menú contextual (acciones)
            contextMenu.addEventListener('click', (event) => {
                const action = event.target.dataset.action;
                if (currentDebtIdForContext && action) {
                    if (action === 'markAsPaid') {
                        markAsPaid(currentDebtIdForContext);
                    } else if (action === 'deleteDebt') {
                        deleteDebt(currentDebtIdForContext);
                    } else if (action === 'editDebt') {
                        editDebt(currentDebtIdForContext);
                    } else if (action === 'viewIndividualPlan') {
                        showIndividualDebtPlan(currentDebtIdForContext);
                    }
                }
                contextMenu.classList.add('hidden');
            });

            // Ocultar menú contextual al hacer clic en cualquier otro lugar
            document.addEventListener('click', (event) => {
                if (!contextMenu.classList.contains('hidden') && !contextMenu.contains(event.target) && !event.target.closest('.options-btn')) {
                    contextMenu.classList.add('hidden');
                }
            });

            // Spotlight Search (⌘K)
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('spotlightSearch').focus();
                }
            });

            // Exportar a Excel
            exportExcelBtn.addEventListener('click', () => {
                const debtDataForExport = debts.map(debt => ({
                    Nombre: debt.name,
                    Monto: debt.amount,
                    'Cuota Mensual Estimada': calculateMonthlyPayment(debt.amount, debt.termInMonths),
                    Vencimiento: formatDate(debt.dueDate),
                    Categoría: debt.category,
                    'Plazo (meses)': debt.termInMonths,
                    'Ahorro Diario Recomendado': calculateIndividualDebtSavings(debt.amount, debt.termInMonths).daily,
                    'Ahorro Quincenal Recomendado': calculateIndividualDebtSavings(debt.amount, debt.termInMonths).biWeekly,
                    Estado: debt.status
                }));

                const expenseDataForExport = fixedExpenses.map(expense => ({
                    Nombre: expense.name,
                    Monto: expense.amount,
                    Frecuencia: expense.frequency
                }));

                const { totalDebt, actualMonthlyIncome, available, totalFixedExpenses, monthlyDebtPayments } = calculateFinancialSummary();
                const targetTermMonths = parseFloat(targetTermMonthsInput.value) || 12;
                const dailySavingsVal = parseCurrency(dailySavingsElement.textContent);
                const biWeeklySavingsVal = parseCurrency(biWeeklySavingsElement.textContent);


                const summaryData = [
                    ['Resumen Financiero y Plan de Ahorro Global'],
                    ['Total Deudas Pendientes', formatCurrency(totalDebt)],
                    ['Dinero Disponible (mensual)', formatCurrency(available)],
                    ['Porcentaje de Deuda vs. Ingresos', debtPercentageElement.textContent],
                    ['Ingreso Mensual', formatCurrency(actualMonthlyIncome)],
                    ['Total Gastos Fijos Mensuales', formatCurrency(totalFixedExpenses)],
                    ['Total Pagos Mínimos de Deudas Mensuales', formatCurrency(monthlyDebtPayments)],
                    ['Plazo Deseado para Saldar Todas las Deudas (meses)', targetTermMonths],
                    ['Ahorro Diario Necesario', formatCurrency(dailySavingsVal)],
                    ['Ahorro Quincenal Necesario', formatCurrency(biWeeklySavingsVal)]
                ];

                const wb = XLSX.utils.book_new();

                if (debtDataForExport.length > 0) {
                    const wsDebts = XLSX.utils.json_to_sheet(debtDataForExport);
                    XLSX.utils.book_append_sheet(wb, wsDebts, "Deudas");
                } else {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["No hay datos de deudas para exportar."]]), "Deudas");
                }

                if (expenseDataForExport.length > 0) {
                    const wsExpenses = XLSX.utils.json_to_sheet(expenseDataForExport);
                    XLSX.utils.book_append_sheet(wb, wsExpenses, "Gastos Fijos");
                } else {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["No hay datos de gastos fijos para exportar."]]), "Gastos Fijos");
                }
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen General");


                XLSX.writeFile(wb, "Finanzas_Personales.xlsx");
                showToast('Datos exportados a Excel exitosamente.', 'info');
            });

            resetAllDataBtn.addEventListener('click', () => {
                showModal({
                    title: 'Confirmar Restablecimiento Total',
                    message: '¿Estás seguro de que deseas RESTABLECER TODOS los datos? Esta acción es irreversible.',
                    type: 'warning',
                    onConfirm: () => {
                        localStorage.clear();
                        debts = [];
                        fixedExpenses = [];
                        monthlyIncome = 0;
                        incomeFrequency = 'Mensual';
                        editingDebtId = null;
                        editingFixedExpenseId = null;
                        
                        debtForm.reset();
                        fixedExpenseForm.reset();
                        monthlyIncomeAmountInput.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(0);
                        incomeFrequencySelect.value = 'Mensual';
                        targetTermMonthsInput.value = '12';
                        monthlySavingsSlider.value = '100000'; 
                        incomeChangeSlider.value = '0';
                        expenseChangeSlider.value = '0';

                        simulationResultsDiv.classList.add('hidden');

                        updateUI();
                        showToast('Todos los datos han sido restablecidos.', 'warning');
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            });

            // --- Individual Debt Plan Modal Functions ---

            function showIndividualDebtPlan(debtId) {
                activeDebtForIndividualPlan = debts.find(d => d.id === debtId);
                if (!activeDebtForIndividualPlan) {
                    showToast('Deuda no encontrada.', 'error');
                    return;
                }

                modalDebtName.textContent = activeDebtForIndividualPlan.name;
                modalDebtAmount.textContent = formatCurrency(activeDebtForIndividualPlan.amount);
                modalTermInMonths.textContent = `${activeDebtForIndividualPlan.termInMonths || 'N/A'} meses`;
                modalMonthlyPayment.textContent = formatCurrency(calculateMonthlyPayment(activeDebtForIndividualPlan.amount, activeDebtForIndividualPlan.termInMonths));
                
                extraPaymentAmountInput.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(0); // Reset extra payment input

                renderAmortizationSchedule(activeDebtForIndividualPlan, 0);

                individualPlanModal.classList.remove('hidden');
            }

            closeIndividualPlanModalBtn.addEventListener('click', () => {
                individualPlanModal.classList.add('hidden');
                activeDebtForIndividualPlan = null;
                amortizationSummary.classList.add('hidden'); 
            });

            recalculatePlanBtn.addEventListener('click', () => {
                if (!activeDebtForIndividualPlan) return;

                const extraPayment = parseCurrency(extraPaymentAmountInput.value);
                if (isNaN(extraPayment) || extraPayment < 0) {
                    extraPaymentError.classList.remove('hidden');
                    extraPaymentAmountInput.classList.add('input-error');
                    showToast('Por favor, ingresa un monto de pago adicional válido.', 'error');
                    return;
                } else {
                    extraPaymentError.classList.add('hidden');
                    extraPaymentAmountInput.classList.remove('input-error');
                }
                renderAmortizationSchedule(activeDebtForIndividualPlan, extraPayment);
            });

            extraPaymentAmountInput.addEventListener('input', () => formatInputAsCurrencyLive(extraPaymentAmountInput));
            extraPaymentAmountInput.addEventListener('blur', (e) => {
                const value = parseCurrency(e.target.value);
                if (!isNaN(value)) {
                    e.target.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 2
                    }).format(value);
                }
            });
            extraPaymentAmountInput.addEventListener('focus', (e) => {
                e.target.value = parseCurrency(e.target.value);
            });


            function calculateAmortizationSchedule(debt, extraPayment = 0) {
                let currentPrincipal = debt.amount;
                const originalMonthlyPayment = calculateMonthlyPayment(debt.amount, debt.termInMonths);
                
                let schedule = [];
                let month = 0;
                let totalInterestPaid = 0; 

                const maxMonths = 360; 

                while (currentPrincipal > 0.01 && month < maxMonths) {
                    month++;
                    const interestThisMonth = 0; 
                    let principalPaidThisMonth = originalMonthlyPayment + extraPayment;

                    if (principalPaidThisMonth > currentPrincipal) {
                        principalPaidThisMonth = currentPrincipal;
                    }

                    const totalPaymentThisMonth = principalPaidThisMonth; 
                    currentPrincipal -= principalPaidThisMonth;
                    totalInterestPaid += interestThisMonth; 

                    schedule.push({
                        month: month,
                        startingBalance: currentPrincipal + principalPaidThisMonth, 
                        principalPaid: principalPaidThisMonth,
                        totalPayment: totalPaymentThisMonth,
                        endingBalance: currentPrincipal
                    });
                }
                return { schedule, totalMonths: month, totalInterestPaid };
            }

            function renderAmortizationSchedule(debt, extraPayment) {
                const { schedule, totalMonths, totalInterestPaid } = calculateAmortizationSchedule(debt, extraPayment);
                amortizationTableBody.innerHTML = '';

                if (schedule.length === 0) {
                    amortizationTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No se pudo calcular el plan de pago.</td></tr>`;
                    amortizationSummary.classList.add('hidden');
                    return;
                }

                schedule.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.month}</td>
                        <td>${formatCurrency(entry.startingBalance)}</td>
                        <td>${formatCurrency(entry.principalPaid)}</td>
                        <td>${formatCurrency(entry.totalPayment)}</td>
                        <td>${formatCurrency(Math.max(0, entry.endingBalance))}</td>
                    `;
                    amortizationTableBody.appendChild(row);
                });

                summaryMonths.textContent = totalMonths;
                summaryTotalInterest.textContent = formatCurrency(totalInterestPaid);
                amortizationSummary.classList.remove('hidden');
            }

            // --- Gemini API Integration for Personalized Debt Strategy ---
            async function getPersonalizedDebtStrategy() {
                geminiButtonText.textContent = 'Generando estrategia...';
                geminiLoadingSpinner.classList.remove('hidden');
                getGeminiStrategyBtn.disabled = true;
                geminiStrategyOutput.classList.add('hidden'); // Hide previous output

                const { totalDebt, actualMonthlyIncome, available, totalFixedExpenses, monthlyDebtPayments } = calculateFinancialSummary();
                const pendingDebts = debts.filter(d => d.status === 'Pendiente');

                let prompt = `Soy un usuario de una aplicación de finanzas personales. Mi ingreso mensual es de ${formatCurrency(actualMonthlyIncome)}. Mis gastos fijos mensuales suman ${formatCurrency(totalFixedExpenses)}. Mis pagos mínimos mensuales de deudas suman ${formatCurrency(monthlyDebtPayments)}. Actualmente tengo ${pendingDebts.length} deudas pendientes.`;

                if (pendingDebts.length > 0) {
                    prompt += `\n\nMis deudas pendientes son:\n`;
                    pendingDebts.forEach(debt => {
                        prompt += `- ${debt.name}: ${formatCurrency(debt.amount)}, plazo: ${debt.termInMonths || 'N/A'} meses, categoría: ${debt.category}.\n`;
                    });
                } else {
                    prompt += `\n\nActualmente no tengo deudas pendientes.`;
                }

                prompt += `\n\nBasado en esta información, por favor, sugiere una estrategia de pago de deudas personalizada. Incluye consejos prácticos, pasos realistas y considera cómo puedo optimizar mis finanzas. Si no tengo deudas, dame consejos para mantener una buena salud financiera y ahorrar. Responde en español y utiliza un formato claro con puntos o pasos numerados.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        geminiStrategyOutput.innerHTML = `<h4 class="font-bold text-lg mb-2">Recomendación de Gemini:</h4><p class="whitespace-pre-wrap">${text}</p>`;
                        geminiStrategyOutput.classList.remove('hidden');
                        showToast('Estrategia personalizada generada.', 'success');
                    } else {
                        geminiStrategyOutput.innerHTML = `<p class="text-red-500">Error: No se pudo generar la estrategia. Inténtalo de nuevo más tarde.</p>`;
                        geminiStrategyOutput.classList.remove('hidden');
                        showToast('Error al generar la estrategia.', 'error');
                        console.error("Unexpected API response structure:", result);
                    }
                } catch (error) {
                    geminiStrategyOutput.innerHTML = `<p class="text-red-500">Error de conexión: ${error.message}. Asegúrate de tener conexión a internet.</p>`;
                    geminiStrategyOutput.classList.remove('hidden');
                    showToast('Error de red al generar la estrategia.', 'error');
                    console.error("Fetch error:", error);
                } finally {
                    geminiButtonText.textContent = 'Obtener Estrategia Personalizada ✨';
                    geminiLoadingSpinner.classList.add('hidden');
                    getGeminiStrategyBtn.disabled = false;
                }
            }

            // --- New LLM Feature: Quick Financial Advisor ---
            async function getFinancialAdvice() {
                const question = financialQuestionInput.value.trim();
                if (!question) {
                    showToast('Por favor, escribe tu pregunta para el consejero financiero.', 'warning');
                    return;
                }

                aiAdviceButtonText.textContent = 'Obteniendo consejo...';
                aiAdviceLoadingSpinner.classList.remove('hidden');
                getAiAdviceBtn.disabled = true;
                aiAdviceOutput.classList.add('hidden'); // Hide previous output

                const prompt = `Soy un usuario de una aplicación de finanzas personales. Necesito un consejo general sobre la siguiente pregunta financiera: "${question}". Por favor, proporciona una respuesta concisa, práctica y fácil de entender. No pidas información personal ni te refieras a mis datos específicos. Responde en español.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiAdviceOutput.innerHTML = `<h4 class="font-bold text-lg mb-2">Consejo de Gemini:</h4><p class="whitespace-pre-wrap">${text}</p>`;
                        aiAdviceOutput.classList.remove('hidden');
                        showToast('Consejo financiero generado.', 'success');
                    } else {
                        aiAdviceOutput.innerHTML = `<p class="text-red-500">Error: No se pudo generar el consejo. Inténtalo de nuevo más tarde.</p>`;
                        aiAdviceOutput.classList.remove('hidden');
                        showToast('Error al generar el consejo.', 'error');
                        console.error("Unexpected API response structure:", result);
                    }
                } catch (error) {
                    aiAdviceOutput.innerHTML = `<p class="text-red-500">Error de conexión: ${error.message}. Asegúrate de tener conexión a internet.</p>`;
                    aiAdviceOutput.classList.remove('hidden');
                    showToast('Error de red al generar el consejo.', 'error');
                    console.error("Fetch error:", error);
                } finally {
                    aiAdviceButtonText.textContent = 'Obtener Consejo Financiero ✨';
                    aiAdviceLoadingSpinner.classList.add('hidden');
                    getAiAdviceBtn.disabled = false;
                }
            }


            // --- Inicialización y Actualización General de UI ---
            function updateUI() {
                calculateFinancialSummary();
                calculateGlobalSavingsNeeded();
                renderDebts(debts); 
                renderFixedExpenses();
                updateCurrencySymbolInInputs(); // Update currency symbol in inputs
                
                savingsValueDisplay.textContent = formatCurrency(parseCurrency(monthlySavingsSlider.value));
                compareStrategies(); 

                incomeChangeValueDisplay.textContent = `${incomeChangeSlider.value}%`;
                expenseChangeValueDisplay.textContent = `${expenseChangeSlider.value}%`;

                checkFinancialHealth(); 
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Set initial currency selector value
                currencySelect.value = currentCurrencyCode;
                // Populate currency options
                for (const code in CURRENCIES) {
                    if (!currencySelect.querySelector(`option[value="${code}"]`)) {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = `${code} (${CURRENCIES[code].symbol})`;
                        currencySelect.appendChild(option);
                    }
                }


                monthlyIncomeAmountInput.value = new Intl.NumberFormat(CURRENCIES[currentCurrencyCode].locale, { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(monthlyIncome);
                incomeFrequencySelect.value = incomeFrequency;
                updateUI();

                // Event listener for currency change
                currencySelect.addEventListener('change', (event) => {
                    currentCurrencyCode = event.target.value;
                    localStorage.setItem('selectedCurrency', currentCurrencyCode);
                    updateUI();
                    showToast(`Moneda cambiada a ${CURRENCIES[currentCurrencyCode].name}.`, 'info');
                });

                monthlySavingsSlider.addEventListener('input', () => {
                    savingsValueDisplay.textContent = formatCurrency(parseCurrency(monthlySavingsSlider.value));
                    compareStrategies();
                });

                showSnowballPlanBtn.addEventListener('click', () => {
                    const pendingDebts = debts.filter(d => d.status === 'Pendiente');
                    const snowball = calculatePayoffStrategy(pendingDebts, parseCurrency(monthlySavingsSlider.value), PAYMENT_STRATEGIES.SNOWBALL);
                    monthlyPlanResultsDiv.innerHTML = generateMonthlyPlanHTML(snowball);
                });

                showAvalanchePlanBtn.addEventListener('click', () => {
                    const pendingDebts = debts.filter(d => d.status === 'Pendiente');
                    const avalanche = calculatePayoffStrategy(pendingDebts, parseCurrency(monthlySavingsSlider.value), PAYMENT_STRATEGIES.AVALANCHE);
                    monthlyPlanResultsDiv.innerHTML = generateMonthlyPlanHTML(avalanche);
                });

                incomeChangeSlider.addEventListener('input', () => {
                    incomeChangeValueDisplay.textContent = `${incomeChangeSlider.value}%`;
                });

                expenseChangeSlider.addEventListener('input', () => {
                    expenseChangeValueDisplay.textContent = `${expenseChangeSlider.value}%`;
                });

                runSimulationBtn.addEventListener('click', runScenarioSimulation);

                // Gemini API button event listener for Debt Strategy
                getGeminiStrategyBtn.addEventListener('click', getPersonalizedDebtStrategy);

                // New Gemini API button event listener for Financial Advisor
                getAiAdviceBtn.addEventListener('click', getFinancialAdvice);
            });
        })(); 
    </script>
</body>
</html>
